Menu="DriveStandbyMonitor:1"
Title="Standby Averages"
Tag="logo-x16.png"
Markdown="false"
---
<?
#Pull some default data
libxml_use_internal_errors(true); # Suppress any warnings from xml errors.

$scriptName = "DriveStandbyMonitor";
$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';
$pluginRoot = "$docroot/plugins/$scriptName";
include_once( "./plugins/$scriptName/includes/page.php" );

$DRIVE_STATUS = array();

$DSM = new DisksInfo( $disks );
$DB = new DSMDB( $DB_FILE );

# Sorter for DRIVE_STATUS
function cleanName ($name){
    if ( stristr($name, 'disk')  !== false ){
        return array(
            "Disk",
            (int) rtrim( substr($name, 4))
        );
    }elseif ( stristr($name, 'cache') !== false ){
        return array(
            "Cache",
            (int) rtrim( substr($name, 5) )
        );

    }elseif ( stristr($name, 'parity')  !== false ){
        return array(
            "Parity",
            (int) rtrim( substr($name, 6) )
        );
    }else{
        return array($name, 0);
    }
}


function alphasort($a, $b){
    $a_name = "";
    $a_id = 0;
    $b_name = "";
    $b_id = 0;


    list($a_name, $a_id) = cleanName($a["name"]);
    list($b_name, $b_id) = cleanName($b["name"]);

    if ( $a_name == "Parity" && $b_name == "Parity" ){
        if ($a_id == $b_id) return 0;
        return ($a_id < $b_id) ? -1 : 1;

    }elseif ( $a_name == "Parity" && ( $b_name == "Disk" || $b_name == "Cache" )){
        return -1;
    }elseif ( $a_name == "Disk" && $b_name == "Disk" ){
        if ($a_id == $b_id) return 0;
        return ($a_id < $b_id) ? -1 : 1;

    }elseif ( $a_name == "Disk" && $b_name == "Parity" ){
        return 1;
    }elseif ( $a_name == "Disk" && $b_name == "Cache" ){
        return -1;
    }elseif ( $a_name == "Cache" && $b_name == "Cache" ){
        if ($a_id == $b_id) return 0;
        return ($a_id < $b_id) ? -1 : 1;

    }elseif ( $a_name == "Cache" && $b_name == "Parity" ){
        return 1;
    }elseif ( $a_name == "Cache" && $b_name == "Disk" ){
        return 1;
    }

    if ($a == $b) return 0;
    return ($a < $b) ? -1 : 1;

}

while ( $data = $DB->getStandbyDisks() ){
    $DRIVE_STATUS[ $data["drive"] ]['standby'] = $data["count"];
}

while ( $data = $DB->getLiveDisks() ){
    $DRIVE_STATUS[ $data["drive"] ]['live'] = $data["count"];
}

if( count($DRIVE_STATUS) === 0 ) {
    print("No data has been collected yet\n");
    print("Please wait up to 20 minutes for an update to occur.\n");

}else{

    # Calculate AVG & Set Name
    foreach ( $DRIVE_STATUS as $key => $val){
        $live = isset( $val['live'] ) ? $val['live'] : 0;
        $standby = isset( $val['standby'] ) ? $val['standby'] : 0;
        
        $DRIVE_STATUS[$key]['name'] = $DSM->getDeviceName( $key );

        if ($standby < 1) {
            $DRIVE_STATUS[$key]['avg'] = 0;
        }else{
            $DRIVE_STATUS[$key]['avg'] = round( ( 100 * ( $standby / ($live + $standby) ) ), 2 );
        }
    }

    # Sort the list
    usort($DRIVE_STATUS,"alphasort");

}
?>
<style type="text/css">
.DSM-wrapper {
    width: 100%;
}

.DSM-container {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;

}

.DSM-drive {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    min-height: 150px;
    justify-content: center;
    align-items: center;
}

.DSM-drive .header i{
    font-size: 64px;
}

.DSM-drive .body{
    display: flex;
    flex-direction: row;
}

.DSM-drive .body .name{
    margin-right: 10px;
}

.DSM-reset-db {
    width: 150px;
    text-align: center;
}
</style>

<div class="DSM-wrapper">
    <div class="DSM-container">
        <? foreach ( $DRIVE_STATUS as $key => $val) { ?>
            <div class="DSM-drive" title="This drive has been asleep for <? print($val['avg']); ?>% of the monitored time.">
                <div class="header">
                    <div class="image">
                        <i class="fa fa-hdd-o big white-text"></i>
                    </div>
                </div>
                <div class="body">
                    <div class="name">
                        <?=$val['name']; ?>
                    </div>
                    <div class="data">
                        <? print($val['avg']); ?>%
                    </div>
                </div>
            </div>
        <? } ?>
    </div>
    <div class="DSM-container">
        <div class="DSM-reset-db">
            <input type="button" id="DSM-reset-db" value="Reset DB" />
        </div>
    </div>
</div>
<script type="text/javascript">

async function resetDB(){
    const response = await fetch("/plugins/<?=$scriptName?>/reset_db.php", { "reset" : 1 } );
    const json = await response.json();
    window.location.reload(true);
    // Do some error checking later
}

document.addEventListener( 'DOMContentLoaded', () => {
    document.querySelector("#DSM-reset-db").addEventListener("click", () => {
        
        const confirmation = confirm("Are you sure you want to delete all previously logged data?\nThis cannot be undone.");
        
        if ( confirmation ) {
            resetDB();
        }
        
    });
});

</script>