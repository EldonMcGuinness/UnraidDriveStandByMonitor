Menu="DriveStandbyMonitor:2"
Title="Standby Data"
Tag="table"
Markdown="false"
---
<?
#Pull some default data
libxml_use_internal_errors(true); # Suppress any warnings from xml errors.
$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';
$script = "DriveStandbyMonitor";
$defaults = @parse_ini_file("$docroot/plugins/DriveStandbyMonitor/default.cfg") ?: [];
$DB_LOCATION = $defaults["DB_LOCATION"];


$DB_FILE = "${DB_LOCATION}/monitor.db";
$DRIVE_STATUS = array();

$sql_data = "SELECT * from 'standby' order by 'standby'.'drive', 'standby'.'date' DESC;";
$sql_drives = "SELECT 'standby'.'drive' from 'standby' group by 'standby'.'drive' order by 'standby'.'drive' ASC;";

# Get the DB info and data on the drives
$sqlite = new SQLite3( $DB_FILE );
$data_result = $sqlite->query( $sql_data );
$drives_result = $sqlite->query( $sql_drives );
?>

<style type="text/css">
    .inner-wrapper {
        margin: 48px;
        text-align: center;
    }

    table tr.hidden {
        display:none;
    }
</style>    
<div class="inner-wrapper">
    <div>
        <span>Show Only:</span>
        <select id="show-only">
            <option value="all">All</option>
        <? while ($drives = $drives_result->fetchArray()) { ?>
            <option value="<?=$drives['drive']?>"><?=$drives['drive']?></option>
        <? } ?>
        </select>
    </div>
</div>
<table class="disk_status wide">
    <thead>
        <tr>
            <td title="">Device</td>
            <td></td>
            <td title="" style="text-align:center;">Standby</td>
            <td></td>
            <td></td>
            <td></td>            
            <td title="" style="text-align:center;">Time/Date</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </thead>
    <tbody>
    <? while ($data = $data_result->fetchArray(SQLITE3_ASSOC)) { ?>
        <tr class="standby <?=$data['drive']?>">
            <td>
                <span class="view"></span>
                <span class="info"></span>
                <i class="icon-disk icon"></i>
                <? print($data['drive']); ?>
            </td>
            <td></td>
            <td style="text-align:center;">
                <? echo ($data['state']) ? "Active" : "Standby"; ?>
            </td>
            <td></td>
            <td></td>
            <td></td>
            <td>
                <? echo date("H:i:s / Y-m-d", $data['date']); ?>
            </td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    <? } ?>
    </tbody>
</table>
<script type="text/javascript">
document.addEventListener( 'DOMContentLoaded', () => {
    document.querySelector("#show-only").addEventListener("change", (e) => {

        let rows = document.querySelectorAll("table tr.standby");
        let selected = e.target.value;

        for ( let row of rows ){
            if ( row.classList.contains( selected ) || selected == "all" ) {
                row.classList.remove( "hidden" );

            } else {
                row.classList.add( "hidden" );

            }

        }
        
    });
});
</script>