Menu="DriveStandbyMonitor"
Type="xmenu"
Title="Log"
Tabs="false"
---
<?
#Pull some default data
libxml_use_internal_errors(true); # Suppress any warnings from xml errors.
$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';
$defaults = @parse_ini_file("$docroot/plugins/DriveStandbyMonitor/default.cfg") ?: [];
$DB_LOCATION = $defaults["DB_LOCATION"];


$DB_FILE = "${DB_LOCATION}/monitor.db";
$DRIVE_STATUS = array();

$sql_standby = "SELECT 'standby'.'drive', count('standby'.'state') AS count from 'standby' where 'standby'.'state' == 1 group by 'standby'.'drive';";
$sql_live = "SELECT 'standby'.'drive', count('standby'.'state') AS count from 'standby' where 'standby'.'state' == 0 group by 'standby'.'drive';";

# Get the DB info and data on the drives
$sqlite = new SQLite3( $DB_FILE );
$live_result = $sqlite->query( $sql_live );
$standby_result = $sqlite->query( $sql_standby );

# Sorter for DRIVE_STATUS
function alphasort($a, $b){
	if ($a == $b) return 0;
	return ($a < $b) ? -1 : 1; 
}

?>

<pre>
<? 

while ($data = $live_result->fetchArray(SQLITE3_ASSOC)){
        $DRIVE_STATUS[ $data["drive"] ]['live'] = $data["count"];

}

while ($data = $standby_result->fetchArray(SQLITE3_ASSOC)){
        $DRIVE_STATUS[ $data["drive"] ]['standby'] = $data["count"];
}


if( count($DRIVE_STATUS) === 0 ) {
        print("No data has been collected yet\n");
        print("Please make sure you have either rebooted or run update_cron from a terminal,\n");
        print("then wait 20 minutes for an update to occur.\n");
		
}else{

	# Calculate AVG
	foreach ( $DRIVE_STATUS as $key => $val){
			$live = isset( $val['live'] ) ? $val['live'] : 0;
			$standby = isset( $val['standby'] ) ? $val['standby'] : 0;

			if ($standby < 1) {
				$DRIVE_STATUS[$key]['avg'] = 0;
			}else{
				$DRIVE_STATUS[$key]['avg'] = round( ( 100 * ( $standby / ($live + $standby) ) ), 2 );
			}
	}

	# Sort the list
	uasort($DRIVE_STATUS,"alphasort");

	# Print
	foreach ( $DRIVE_STATUS as $key => $val){
		print( "/dev/${key}: ${val['avg']}%\n");
	}
}
?>
</pre>